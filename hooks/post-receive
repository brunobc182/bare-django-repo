#!/usr/bin/env bash

./utils/pull_updates.sh

source ./utils/log_messages.sh

section "Check dependencies"
./utils/check_dependencies.sh
check_error $?

while read oldrev newrev refname; do
  if [ ${refname} == "refs/heads/master" ]; then
    # Set the necessary locations
    PROJECT_PATH=$(dirname `pwd`)
    APP_PATH=$(dirname ${PROJECT_PATH})

    GIT_WORK_TREE=${PROJECT_PATH} git checkout -f
    GIT_WORK_TREE=${PROJECT_PATH} git reset --hard

    section "Set project's environment"
    ENV_FILE=${APP_PATH}/.env
    for line in $(cat ${ENV_FILE}); do echo ${line}; done
    cp ${ENV_FILE} ${PROJECT_PATH}
    check_error $?

    section "Activate the virtual environment"
    cd ${PROJECT_PATH}
    source ${PROJECT_PATH}/env/bin/activate
    check_error $?
    log $(python --version 2>&1) # Solution source: http://stackoverflow.com/a/23862813/4694834
    log "$(pip --version)"

    section "Install project's requirements"
    pip install -qr requirements.txt
    check_error $?

    section "Get project's static files"
    python manage.py collectstatic --no-input
    check_error $?

    if [ -f app.json ]; then
      section "Run commands from \"scripts.webfaction.prerestart\" list found in \"app.json\""
      cat app.json | jq -r '.scripts.webfaction.prerestart[]?' | while read COMMAND; do
        if [ "${COMMAND}" != "" ]; then
          log "Run \"${COMMAND}\""
          ${COMMAND}
          check_error $?
        fi
      done
    else
      log "\"app.json\" not found."
      log "Check \"https://github.com/dewayinc/bare-django-repo\" for more info about \"app.json\" file."
    fi

    section "Restart Apache server"
    ${APP_PATH}/apache2/bin/restart
    check_error $?

    success "Deploy performed successfully"
  else
    error "Not the master branch. Deployment process skipped."
  fi
done
